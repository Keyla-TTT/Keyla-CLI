name: Semantic Release

on:
  push:
    branches:
      - release
      - hotfix/*
      - feature/*

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  check-source:
    runs-on: ubuntu-latest
    outputs:
        should-continue: ${{ steps.check.outputs.result }}
    steps:
        -   name: Checkout
            uses: actions/checkout@v4
            with:
                fetch-depth: 0

        -   name: Check if push comes from main
            id: check
            run: |
                # Verifica se l'ultimo commit su release esiste anche su main
                COMMIT_SHA="${{ github.sha }}"
                if git branch --contains $COMMIT_SHA | grep -q "origin/main"; then
                  echo "result=true" >> $GITHUB_OUTPUT
                else
                  echo "result=false" >> $GITHUB_OUTPUT
                  echo "Push su release deve provenire da main branch"
                  exit 1
                fi

  release:
    needs: check-source
    if: needs.check-source.outputs.should-continue == 'true'
    name: Build and Release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: linuxX64
            binary_name: keyla-linux
            platform_path: linuxX64
          - os: macos-latest
            arch: macosArm64
            binary_name: keyla-macos-arm64
            platform_path: macosArm64
          - os: windows-latest
            arch: mingwX64
            binary_name: keyla-windows.exe
            platform_path: mingwX64

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for semantic-release

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Linux native dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev zlib1g-dev

      - name: Install curl on macOS
        if: runner.os == 'macOS'
        run: |
          brew install curl
          echo "PKG_CONFIG_PATH=/opt/homebrew/opt/curl/lib/pkgconfig" >> $GITHUB_ENV
          echo "LDFLAGS=-L/opt/homebrew/opt/curl/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/opt/homebrew/opt/curl/include" >> $GITHUB_ENV
          echo "PATH=/opt/homebrew/opt/curl/bin:$PATH" >> $GITHUB_ENV

      - name: Cache Kotlin Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: kotlin-native-compiler-${{ runner.os }}-${{ hashFiles('gradle.lockfile') }}

      - name: Debug runner info
        run: |
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner Arch: ${{ runner.arch }}"
          echo "Runner Name: ${{ runner.name }}"
          echo "Matrix Arch: ${{ matrix.arch }}"
          echo "Platform Path: ${{ matrix.platform_path }}"
          uname -m

      - name: Build Native Executable
        run: |
          echo "Building for ${{ matrix.arch }}"
          ./gradlew linkReleaseExecutable${{ matrix.arch }}
        shell: bash

      - name: Rename binary for upload
        run: |
          mkdir -p dist
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp build/bin/${{ matrix.platform_path }}/releaseExecutable/Keyla.exe dist/${{ matrix.binary_name }}
          else
            cp build/bin/${{ matrix.platform_path }}/releaseExecutable/Keyla.kexe dist/${{ matrix.binary_name }}
          fi
        shell: bash

      - name: Upload binaries for semantic-release
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ runner.os }}
          path: dist/*

  documentation:
      name: Generate Documentation
      runs-on: ubuntu-latest
      steps:
          -   name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

          -   name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: 'gradle'

          -   name: Generate Dokka documentation
              run: |
                ./gradlew dokkaHtml
                echo "Documentation generated at:"
                ls -la build/dokka/html/

          -   name: Upload documentation
              uses: actions/upload-artifact@v4
              with:
                  name: dokka-documentation
                  path: build/dokka/html/

  publish:
    name: Run Semantic Release
    needs: [release, documentation]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Install semantic-release plugins
        run: |
          npm install --save-dev semantic-release @semantic-release/commit-analyzer @semantic-release/release-notes-generator @semantic-release/changelog @semantic-release/git @semantic-release/github

      - name: List downloaded files
        run: |
          echo "=== Downloaded artifacts structure ==="
          find dist -type f -exec ls -la {} \;
          echo "=== Artifact directories ==="
          ls -la dist/
          echo "=== Native artifacts ==="
          ls -la dist/native-* || echo "No native artifacts found"
          echo "=== Contents of each native directory ==="
          for dir in dist/native-*; do
            if [ -d "$dir" ]; then
              echo "--- $dir ---"
              ls -la "$dir"
            fi
          done

      - name: Run Semantic Release with assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: npx semantic-release --extends ./release.config.js

  deploy-docs:
      name: Deploy Documentation
      needs: [ publish ]
      runs-on: ubuntu-latest
      permissions:
          contents: write
      steps:
          -   name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

          -   name: Download documentation
              uses: actions/download-artifact@v4
              with:
                  name: dokka-documentation
                  path: docs

          -   name: Deploy to GitHub Pages
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  folder: docs
                  branch: gh-pages
