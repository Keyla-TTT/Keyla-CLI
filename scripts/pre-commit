#!/usr/bin/env sh

echo "üîç Running pre-commit checks..."

# Detect Windows and use appropriate command
if [ -f "./gradlew.bat" ] && [ "$OSTYPE" = "win32" -o "$OSTYPE" = "msys" -o "$OSTYPE" = "cygwin" ]; then
    GRADLE_CMD="cmd.exe /c gradlew.bat"
else
    GRADLE_CMD="./gradlew"
fi

# Step 1: Run ktlint and detekt checks
echo "Step 1: Running code quality checks..."
$GRADLE_CMD ktlintCheck detekt
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo "Code quality checks failed. Attempting to auto-format..."

    # Step 2: Auto-format code
    echo "Step 2: Auto-formatting code..."
    $GRADLE_CMD ktlintFormat
    FORMAT_EXIT_CODE=$?

    if [ $FORMAT_EXIT_CODE -ne 0 ]; then
        echo "Auto-formatting failed. Please fix issues manually."
        exit 1
    fi

    echo "Code has been auto-formatted. Re-running checks..."
    $GRADLE_CMD ktlintCheck detekt
    EXIT_CODE=$?

    if [ $EXIT_CODE -ne 0 ]; then
        echo "Code quality checks still failing after formatting. Please fix remaining issues manually."
        exit 1
    fi
fi

# Step 3: Run tests
echo "Step 3: Running tests..."
$GRADLE_CMD allTests
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "Tests failed. Please fix failing tests before committing."
    exit 1
fi

echo "All pre-commit checks passed"
